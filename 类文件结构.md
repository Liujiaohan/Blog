# 类文件结构

## 概述

Java虚拟机只与“Class文件”这种特定的二进制文件关联，Class文件格式采用一种类似于C语言结构体的伪结构来存储数据，包括两种数据类型：无符号数和表

## 类文件结构

### 魔数与Class文件的版本

每个Class文件的头4个字节称为魔数，用来确定一个能被虚拟机接受的Class文件，身份识别

### 常量池

它是Class文件结构中与其他项目关联最多的数据类型，也是占用Class文件空间大小最大的数据项目之一，在常量池的入口需要放置意向u2类型的数据，代表常量池容量计数器。从一开始，0016为22但只有21个常量。常量池中主要存放两大类常量：字面量和符号引用。

* 字面量：Java层面的final常量值、字符串常量池
* 符号引用：

1. 类和接口的全限定名
2. 字段的名称和描述符
3. 方法的名称和描述符

当虚拟机运行时需要从常量池获得对应的符号引用，再在类创建和引用是解析、翻译（即动态链接）常量池中的每一个常量都是一个表，总共有14种表，表开始的第一位是一个u1类型的标志位，代表当前这个常量属于哪种类型常量

* <init>和<clinit>的区别：一个是虚拟机在装载一个类初始化的时候调用的（clinit，类构造器）。另一个是在类实例化时调用的（init，实例构造器）

### 访问标志

用于标示一些类或者接口层次的访问信息

### 类索引、父类索引、借口索引集合

Class 文件由这三项数据来确定这个类的继承关系，他们都是U2类型的数据

### 字段表集合

用于描述接口或者类中声明的变量，字段表中不会包括从父类或者父接口继承而来的字段

### 方法表集合

包括访问标志、名称索引、描述符索引、属性表集合

### 属性表集合

* Code属性（表）程序方法体最终经过Javac编译器处理后，最终变成字节码指令储存在code中
* Exceptions属性
* LineNumberTable：描述java源码行号和字节码行号
* LocalVariableTable用于描述栈帧中局部变量表中的变量与Java源码变量名的关系
* SourceFile用于记录生成Class文件的源码文件名称
* ConstantValue：对于非静态类型的变量实在<init>,对于静态变量可以在<cinit>或ConstantValue初始化，一般static final使用ConstantValue（必须为ACC_FINAL）
* InnerClass
* Deprecated及Synthetic属性
* StackMapTable
* Signature属性会为泛型变量记录泛型类型签名信息，Java泛型采用的是擦除法实现的伪范型
* BootstrapMethods属性

### 字节码指令简介

* 加载和存储指令

  * _load将一个局部变量加载到操作栈
  * _store将一个数值操作数栈存储到局部变量表
  * _push _const 将一个常量加载到操作数栈

* 运算指令

  * 加法指令：_add

  * 减法指令：_sub

  * 乘法指令：_mul

  * 除法指令：_div

  * 求余指令:_rem

    .........

* 类型转换指令

* 对象创建与访问指令

* 操作数栈管理指令

  * 将操作数栈的栈顶一个或两个出栈pop、pop2
  * 交换栈顶两个数值swap
  * 复制栈顶一个或两个数值dup、dup2

* 控制转移指令：条件分支ifeq

* 方法调用和返回指令

* 异常处理指令

* 同步指令：monitorenter

### 公有设计和私有实现

Java虚拟机实现必须能够读取Class文件并准确实现包含在其中的Java虚拟机代码，但允许优化Class文件只要它依然能够被读取